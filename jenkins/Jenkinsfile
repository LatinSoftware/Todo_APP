pipeline {
    agent {
        docker {
            image 'python:3.12-slim'
            args '-u root'
        }
    }

    environment {
        PATH = "/root/.local/bin:${env.PATH}"
        // Esta URL debe coincidir con el nombre que le demos al contenedor (--name)
        DATABASE_URL = "postgresql://user:password@tododbtest:5432/todo_db"
    }

    stages {
        stage('Setup Environment') {
            steps {
                script {
                    echo 'Configurando herramientas...'
                    sh 'apt-get update && apt-get install -y curl docker.io'
                    sh 'curl -LsSf https://astral.sh/uv/install.sh | sh'
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '/root/.local/bin/uv sync'
            }
        }

        stage('Run Integration Tests') {
            steps {
                script {
                    // 1. Detectar la red del contenedor actual de Jenkins
                    def networkId = sh(script: "docker inspect \$(hostname) -f '{{range .NetworkSettings.Networks}}{{.NetworkID}}{{end}}'", returnStdout: true).trim()
                    
                    // 2. Levantar Postgres en esa misma red
                    docker.image('postgres:15-alpine').withRun(
                        "--network ${networkId} " + 
                        "--name tododbtest " +
                        "-e POSTGRES_USER=user " +
                        "-e POSTGRES_PASSWORD=password " +
                        "-e POSTGRES_DB=todo_db"
                    ) { c ->
                        echo 'Esperando a que la base de datos esté lista para recibir conexiones...'
                        // Aumentamos a 20s porque Postgres tarda en crear los archivos internos
                        sh 'sleep 20' 
                        
                        echo 'Ejecutando Pytest...'
                        // Pasamos explícitamente la variable de entorno
                        sh "DATABASE_URL=${env.DATABASE_URL} /root/.local/bin/uv run pytest"
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                // Limpieza: Borrar el contenedor de test para que no estorbe en la próxima ejecución
                sh 'docker rm -f tododbtest || true'
                echo 'Finalizando ejecución...'
            }
        }
    }
}